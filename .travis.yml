language: rust
cache:
  cargo: true
  directories:
    - ${HOME}/google-cloud-sdk
sudo: required
git:
  depth: 1
  submodules: false
jobs:
  include:
    - stage: commit
      rust: stable
    - stage: release
      sudo: required
      services: docker
      env:
        - APP=http-gateway
      script:
        - |
          source scripts/ns.setup.profile &&
          scripts/gcloud.install.sh &&
          scripts/k8s.install.sh &&
          scripts/k8s.cluster.init.sh &&
          scripts/skaffold.install.sh &&
          PATH_TO_FILE=${TRAVIS_BUILD_DIR}/k8s scripts/k8s.chart.download.sh &&
          docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} &&
          scripts/skaffold.init.sh &&
          scripts/skaffold.run.sh
    - stage: publish
      rust: stable
      after_success:
        - |
          scripts/gcloud.install.sh &&
          scripts/deploy-docs.sh
script:
  - docker run --rm -d -it -p 1883:1883 -p 9001:9001 eclipse-mosquitto
  - rustup component add rustfmt-preview
  - sed -i 's/git@github.com:/https:\/\/github.com\//' .gitmodules
  - git submodule update --init --recursive
  - |
    git clone https://github.com/eclipse/paho.mqtt.c.git && \
    cd paho.mqtt.c && sudo apt-get install clang && \
    git checkout tags/v1.2.0 && \
    make && sudo make install && \
    cd .. && rm -rf paho.mqtt.c
  - cargo fmt --all -- --write-mode=diff
  - cargo build
  - cargo test
stages:
  - name: warmup
  - name: commit
  - name: test
  - name: release
    if: branch = master AND type = push
  - name: migrate
    if: (branch = master AND type = push) AND env(TRAVIS_TAG) IS present
  - name: publish
    if: branch = master AND type = push
